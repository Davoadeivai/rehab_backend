{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}ویرایش نسخه{% else %}ثبت نسخه جدید{% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css">
<link rel="stylesheet" href="{% static 'css/prescription_form.css' %}">
{% endblock %}

{% block content %}
<div class="container py-4">
    {% if messages %}
    <div aria-live="polite" aria-atomic="true" class="position-relative">
        <div class="toast-container position-absolute top-0 end-0 p-3">
            {% for message in messages %}
            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-success text-white">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong class="me-auto">پیام سیستم</strong>
                    <small>هم‌اکنون</small>
                    <button type="button" class="btn-close btn-close-white ms-2 mb-1" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    {{ message }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark d-flex align-items-center">
                        <i class="fas fa-file-medical ms-2"></i>
                        <h5 class="mb-0">اطلاعات نسخه</h5>
                    </div>
                    <div class="card-body">
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger mb-3">
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="{{ form.patient.id_for_label }}" class="form-label">بیمار</label>
                                {{ form.patient }}
                                <div class="invalid-feedback">{{ form.patient.errors|striptags }}</div>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.medication_type.id_for_label }}" class="form-label">نوع دارو</label>
                                {{ form.medication_type }}
                                <div class="invalid-feedback">{{ form.medication_type.errors|striptags }}</div>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.prescription_type.id_for_label }}" class="form-label">نوع نسخه</label>
                                {{ form.prescription_type }}
                                <div class="invalid-feedback">{{ form.prescription_type.errors|striptags }}</div>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.priority.id_for_label }}" class="form-label">اولویت</label>
                                {{ form.priority }}
                                <div class="invalid-feedback">{{ form.priority.errors|striptags }}</div>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.doctor.id_for_label }}" class="form-label">پزشک معالج</label>
                                {{ form.doctor }}
                                <div class="invalid-feedback">{{ form.doctor.errors|striptags }}</div>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.doctor_code.id_for_label }}" class="form-label">کد نظام پزشکی</label>
                                {{ form.doctor_code }}
                                <div class="invalid-feedback">{{ form.doctor_code.errors|striptags }}</div>
                            </div>
                        </div>
                            </div>
                        </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-pills ms-2"></i>
                        <h5 class="mb-0">جزئیات دارو</h5>
                                        </div>
                                        <div class="card-body">
                        {{ formset.management_form }}
                        {% for item in formset %}
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                <label for="{{ item.medication.id_for_label }}" class="form-label">دارو</label>
                                {{ item.medication }}
                                <div class="invalid-feedback">{{ item.medication.errors|striptags }}</div>
                                                </div>
                                                <div class="col-md-3">
                                <label for="{{ item.dosage.id_for_label }}" class="form-label">مقدار مصرف</label>
                                <div class="input-group">
                                    {{ item.dosage }}
                                    <span class="input-group-text">{{ item.dosage_unit.value|default:'واحد' }}</span>
                                </div>
                                <div class="invalid-feedback">{{ item.dosage.errors|striptags }}</div>
                                                </div>
                                                <div class="col-md-3">
                                <label for="{{ item.dosage_unit.id_for_label }}" class="form-label">واحد</label>
                                {{ item.dosage_unit }}
                                <div class="invalid-feedback">{{ item.dosage_unit.errors|striptags }}</div>
                                                </div>
                                                <div class="col-md-4">
                                <label for="{{ item.frequency.id_for_label }}" class="form-label">نوبت در روز</label>
                                {{ item.frequency }}
                                <div class="invalid-feedback">{{ item.frequency.errors|striptags }}</div>
                                                </div>
                                                <div class="col-md-4">
                                <label for="{{ item.route.id_for_label }}" class="form-label">طریقه مصرف</label>
                                {{ item.route }}
                                <div class="invalid-feedback">{{ item.route.errors|striptags }}</div>
                                                </div>
                                                <div class="col-md-4">
                                <label for="{{ item.duration.id_for_label }}" class="form-label">مدت مصرف (روز)</label>
                                {{ item.duration }}
                                <div class="invalid-feedback">{{ item.duration.errors|striptags }}</div>
                                                    </div>
                                                </div>
                        {{ item.id }}
                        {% endfor %}
                                        </div>
                                    </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-chart-line ms-2"></i>
                        <h5 class="mb-0">مقادیر و سهمیه</h5>
                                </div>
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label for="{{ form.daily_dose.id_for_label }}" class="form-label">مصرف روزانه</label>
                                {{ form.daily_dose }}
                                <div class="invalid-feedback">{{ form.daily_dose.errors|striptags }}</div>
                                </div>
                            <div class="col-md-4">
                                <label for="{{ form.treatment_duration.id_for_label }}" class="form-label">مدت مصرف (روز)</label>
                                {{ form.treatment_duration }}
                                <div class="invalid-feedback">{{ form.treatment_duration.errors|striptags }}</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">پایان پیش‌بینی شده</label>
                                <input type="text" id="end-date-preview" class="form-control" placeholder="—" readonly>
                        </div>
                                <div class="col-md-6">
                                <label for="{{ form.start_date.id_for_label }}" class="form-label">تاریخ شروع</label>
                                    {{ form.start_date }}
                                    <div class="invalid-feedback">{{ form.start_date.errors|striptags }}</div>
                                </div>
                                <div class="col-md-6">
                                <label for="{{ form.end_date.id_for_label }}" class="form-label">تاریخ پایان</label>
                                    {{ form.end_date }}
                                    <div class="invalid-feedback">{{ form.end_date.errors|striptags }}</div>
                                </div>
                            <div class="col-md-6">
                                <label for="{{ form.total_prescribed.id_for_label }}" class="form-label">کل تجویز شده</label>
                                {{ form.total_prescribed }}
                                <div class="invalid-feedback">{{ form.total_prescribed.errors|striptags }}</div>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.allocated_amount.id_for_label }}" class="form-label">سهمیه کلی اختصاص‌یافته</label>
                                {{ form.allocated_amount }}
                                <div class="invalid-feedback">{{ form.allocated_amount.errors|striptags }}</div>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.weekly_quota.id_for_label }}" class="form-label">سهمیه هفتگی</label>
                                {{ form.weekly_quota }}
                                <div class="invalid-feedback">{{ form.weekly_quota.errors|striptags }}</div>
                                </div>
                                <div class="col-md-6">
                                <label for="{{ form.monthly_quota.id_for_label }}" class="form-label">سهمیه ماهانه</label>
                                {{ form.monthly_quota }}
                                <div class="invalid-feedback">{{ form.monthly_quota.errors|striptags }}</div>
                                </div>
                                <div class="col-md-6">
                                <label for="{{ form.period_type.id_for_label }}" class="form-label">نوع بازه سهمیه</label>
                                    {{ form.period_type }}
                                    <div class="invalid-feedback">{{ form.period_type.errors|striptags }}</div>
                                </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-4">
                    <a href="{% url 'patients:prescription_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-right ms-2"></i>انصراف
                    </a>
                    <button type="submit" class="btn btn-warning text-dark">
                        <i class="fas fa-save ms-2"></i>ذخیره
                    </button>
                            </div>
                        </div>

            <div class="col-lg-4">
                <div class="card shadow-sm position-sticky" style="top: 80px;">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-info-circle ms-2"></i>
                        <h6 class="mb-0">خلاصه نسخه</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled small mb-0" id="summary-list">
                            <li class="mb-2">بیمار: <span id="summary-patient">—</span></li>
                            <li class="mb-2">دارو: <span id="summary-medication">—</span></li>
                            <li class="mb-2">مصرف روزانه: <span id="summary-daily">0</span></li>
                            <li class="mb-2">مدت مصرف: <span id="summary-duration">0 روز</span></li>
                            <li class="mb-2">کل تجویز شده: <span id="summary-total">0</span></li>
                            <li class="mb-2">پایان پیش‌بینی شده: <span id="summary-end">—</span></li>
                        </ul>
                        </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{% static 'js/moment.min.js' %}"></script>
<script src="{% static 'js/moment-jalaali.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
        // Select2
        $('select.select2, select.select2-medicine').select2({
            theme: 'bootstrap-5',
            dir: 'rtl',
            width: '100%',
            dropdownAutoWidth: true
        });

        function toNumber(val) {
            const n = parseFloat((val || '0').toString().replace(',', '.'));
            return isNaN(n) ? 0 : n;
        }

        function recalc() {
            const dose = toNumber(document.getElementById('id_daily_dose')?.value);
            const dur = parseInt(document.getElementById('id_treatment_duration')?.value || '0');
            const total = Math.round((dose * dur) * 100) / 100;

            const totalField = document.getElementById('id_total_prescribed');
            if (totalField) totalField.value = total;

            // End date preview (jalali) - use actual start_date if available
            moment.loadPersian({dialect: 'persian-modern'});
            const startDateInput = document.getElementById('id_start_date');
            const startDate = startDateInput && startDateInput.value ? moment(startDateInput.value, 'jYYYY/jMM/jDD') : moment();
            const end = dur > 0 ? startDate.clone().add(dur - 1, 'day') : null;
            const endStr = end ? end.format('jYYYY/jMM/jDD') : '—';
            const endPreview = document.getElementById('end-date-preview');
            if (endPreview) endPreview.value = endStr;

            // Summary
            document.getElementById('summary-daily').innerText = dose;
            document.getElementById('summary-duration').innerText = dur + ' روز';
            document.getElementById('summary-total').innerText = total;
            document.getElementById('summary-end').innerText = endStr;
        }

        // Initialize date pickers
        $('.date-input').each(function() {
            $(this).persianDatepicker({
                format: 'YYYY/MM/DD',
                autoClose: true,
                initialValue: true,
                observer: true,
                timePicker: { enabled: false },
                toolbox: { calendarSwitch: { enabled: false }}
            });
        });

        // Bind events
        const doseInput = document.getElementById('id_daily_dose');
        const durationInput = document.getElementById('id_treatment_duration');
        const startDateInput = document.getElementById('id_start_date');
        if (doseInput) doseInput.addEventListener('input', recalc);
        if (durationInput) durationInput.addEventListener('input', recalc);
        if (startDateInput) startDateInput.addEventListener('change', recalc);

        // Patient/Medication summary
        function updateSummarySelect(id, target) {
            const el = document.getElementById(id);
            const txt = el && el.options && el.selectedIndex >= 0 ? el.options[el.selectedIndex].text : '—';
            document.getElementById(target).innerText = txt || '—';
        }
        ['id_patient','id_medication_type'].forEach((id, idx) => {
            const target = idx === 0 ? 'summary-patient' : 'summary-medication';
            const el = document.getElementById(id);
            if (el) {
                $(el).on('change', () => updateSummarySelect(id, target));
                updateSummarySelect(id, target);
            }
        });

        // Initial calc
        recalc();
});
</script>
{% endblock %} 