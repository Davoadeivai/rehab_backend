{% extends 'base.html' %}
{% load static %}

{% block title %}تقویم نوبت دارویی{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.5.95/css/materialdesignicons.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css" rel="stylesheet">
<link href="https://unpkg.com/tippy.js@6/dist/tippy.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/drug_appointment_calendar.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">تقویم نوبت دارویی</h2>
    <div id="loadingSpinner" class="spinner" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">در حال بارگذاری...</span>
        </div>
    </div>
    <div id="calendar" aria-label="تقویم نوبت‌های دارویی"></div>

    <!-- Modal for add/edit appointment -->
    <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">ثبت نوبت جدید</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
          </div>
          <div class="modal-body">
            <form id="appointmentForm" novalidate>
              {% csrf_token %}
              <input type="hidden" id="appointmentId" name="appointment_id">
              <div class="mb-3">
                <label for="patientSelect" class="form-label">بیمار</label>
                <select class="form-select" id="patientSelect" name="patient_id" required aria-describedby="patientSelectError">
                  <option value="">انتخاب کنید...</option>
                  {% for patient in patients %}
                  <option value="{{ patient.id }}" data-fullname="{{ patient.first_name }} {{ patient.last_name }}" data-code="{{ patient.patient_code }}" data-phone="{{ patient.phone_number }}" data-address="{{ patient.address }}">{{ patient.first_name }} {{ patient.last_name }}</option>
                  {% endfor %}
                </select>
                <div id="patientSelectError" class="invalid-feedback">لطفاً یک بیمار انتخاب کنید.</div>
              </div>
              <div class="mb-3">
                <label for="dateInput" class="form-label">تاریخ نوبت (شمسی)</label>
                <input type="text" class="form-control" id="dateInput" name="date" required placeholder="مثال: ۱۴۰۴/۰۳/۱۷" aria-describedby="dateInputError">
                <div id="dateInputError" class="invalid-feedback">لطفاً یک تاریخ معتبر در آینده وارد کنید.</div>
              </div>
              <div class="mb-3">
                <label for="timeInput" class="form-label">ساعت نوبت</label>
                <input type="time" class="form-control" id="timeInput" name="time" required aria-describedby="timeInputError">
                <div id="timeInputError" class="invalid-feedback">لطفاً یک ساعت معتبر وارد کنید.</div>
              </div>
              <div class="mb-3">
                <label for="statusSelect" class="form-label">وضعیت</label>
                <select class="form-select" id="statusSelect" name="status" aria-describedby="statusSelectError">
                  <option value="scheduled">رزرو شده</option>
                  <option value="completed">تکمیل شده</option>
                  <option value="cancelled">لغو شده</option>
                  <option value="no_show">عدم حضور</option>
                </select>
                <div id="statusSelectError" class="invalid-feedback">لطفاً یک وضعیت انتخاب کنید.</div>
              </div>
              <div class="mb-3">
                <label for="notesInput" class="form-label">یادداشت</label>
                <textarea class="form-control" id="notesInput" name="notes" rows="2" aria-describedby="notesInputError"></textarea>
                <div id="notesInputError" class="invalid-feedback">یادداشت نمی‌تواند خالی باشد.</div>
              </div>
              <div class="mb-3" id="patientInfo" style="display:none; background:#f8f9fa; border-radius:8px; padding:10px;"></div>
              <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary" id="saveBtn">ثبت</button>
                <button type="button" class="btn btn-danger d-none" id="deleteBtn" aria-label="حذف نوبت">حذف</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast for notifications -->
    <div class="toast align-items-center text-bg-success border-0" id="successToast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="successToastBody"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="بستن"></button>
      </div>
    </div>
    <div class="toast align-items-center text-bg-danger border-0" id="errorToast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="errorToastBody"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="بستن"></button>
      </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/min/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment-jalaali@0.9.6/dist/moment-jalaali.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/fa.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<script src="{% static 'js/drug_appointment_calendar.js' %}"></script>
{% endblock %}