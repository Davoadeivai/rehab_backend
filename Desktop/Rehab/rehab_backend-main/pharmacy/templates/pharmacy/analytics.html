{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4 text-primary"><i class="fas fa-chart-bar me-2"></i>گزارش تحلیلی داروخانه</h2>
  <div class="row g-4">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">فروش ماهانه</div>
        <div class="card-body">
          <canvas id="salesByMonthChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">خرید ماهانه</div>
        <div class="card-body">
          <canvas id="purchasesByMonthChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">پرفروش‌ترین داروها</div>
        <div class="card-body">
          <canvas id="topDrugsChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// داده‌های فروش ماهانه
const salesByMonth = {{ sales_by_month|safe }};
const salesLabels = salesByMonth.map(item => item.month ? item.month.substring(0,7) : 'نامشخص');
const salesData = salesByMonth.map(item => item.total);
// داده‌های خرید ماهانه
const purchasesByMonth = {{ purchases_by_month|safe }};
const purchasesLabels = purchasesByMonth.map(item => item.month ? item.month.substring(0,7) : 'نامشخص');
const purchasesData = purchasesByMonth.map(item => item.total);
// داده‌های پرفروش‌ترین داروها
const topDrugs = {{ top_drugs|safe }};
const topDrugsLabels = topDrugs.map(item => item['drug__name']);
const topDrugsData = topDrugs.map(item => item.total);

// نمودار فروش ماهانه
new Chart(document.getElementById('salesByMonthChart'), {
  type: 'line',
  data: {
    labels: salesLabels,
    datasets: [{
      label: 'تعداد فروش',
      data: salesData,
      borderColor: '#0d6efd',
      backgroundColor: 'rgba(13,110,253,0.1)',
      fill: true,
      tension: 0.3
    }]
  },
  options: {responsive: true, plugins: {legend: {display: false}}}
});
// نمودار خرید ماهانه
new Chart(document.getElementById('purchasesByMonthChart'), {
  type: 'line',
  data: {
    labels: purchasesLabels,
    datasets: [{
      label: 'تعداد خرید',
      data: purchasesData,
      borderColor: '#198754',
      backgroundColor: 'rgba(25,135,84,0.1)',
      fill: true,
      tension: 0.3
    }]
  },
  options: {responsive: true, plugins: {legend: {display: false}}}
});
// نمودار پرفروش‌ترین داروها
new Chart(document.getElementById('topDrugsChart'), {
  type: 'bar',
  data: {
    labels: topDrugsLabels,
    datasets: [{
      label: 'تعداد فروش',
      data: topDrugsData,
      backgroundColor: '#0dcaf0'
    }]
  },
  options: {responsive: true, indexAxis: 'y', plugins: {legend: {display: false}}}
});
</script>
{% endblock %} 