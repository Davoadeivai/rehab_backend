{% extends 'patients/medication_dispensing/base_medication_dispensing.html' %}
{% load i18n static %}

{% block page_title %}
    {% if form.instance.pk %}{% trans 'ویرایش تحویل دارو' %}{% else %}{% trans 'ثبت تحویل جدید دارو' %}{% endif %}
{% endblock %}

{% block card_actions %}
<a href="{% if form.instance.pk %}{% url 'patients:medication_dispensing_detail' form.instance.pk %}{% else %}{% url 'patients:medication_dispensing_list' %}{% endif %}" 
   class="btn btn-secondary btn-sm">
    <i class="fas fa-arrow-right me-1"></i>
    {% if form.instance.pk %}{% trans 'بازگشت به جزئیات' %}{% else %}{% trans 'بازگشت به لیست' %}{% endif %}
</a>
{% endblock %}

{% block medication_dispensing_content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas {% if form.instance.pk %}fa-edit{% else %}fa-plus-circle{% endif %} me-2"></i>
                    {% if form.instance.pk %}{% trans 'ویرایش تحویل دارو' %}{% else %}{% trans 'ثبت تحویل جدید دارو' %}{% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="medication-dispensing-form" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="row g-3">
                        <!-- Patient Field -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.patient.id_for_label }}" class="form-label">
                                    {{ form.patient.label }}
                                    {% if form.patient.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.patient }}
                                {% if form.patient.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.patient.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <a href="#" id="patient-info-link" class="text-muted small" style="display: none;">
                                        <i class="fas fa-info-circle"></i> 
                                        <span id="patient-info"></span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Medication Type Field -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.medication_type.id_for_label }}" class="form-label">
                                    {{ form.medication_type.label }}
                                    {% if form.medication_type.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.medication_type }}
                                {% if form.medication_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.medication_type.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <span id="medication-stock" class="text-muted small"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dispensing Date and Type -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.dispensing_date.id_for_label }}" class="form-label">
                                    {{ form.dispensing_date.label }}
                                    {% if form.dispensing_date.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.dispensing_date }}
                                {% if form.dispensing_date.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.dispensing_date.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.dispensing_type.id_for_label }}" class="form-label">
                                    {{ form.dispensing_type.label }}
                                    {% if form.dispensing_type.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.dispensing_type }}
                                {% if form.dispensing_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.dispensing_type.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Quantity and Unit Price -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.quantity.id_for_label }}" class="form-label">
                                    {{ form.quantity.label }}
                                    {% if form.quantity.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                <div class="input-group">
                                    {{ form.quantity }}
                                    <span class="input-group-text" id="unit-display">-</span>
                                </div>
                                {% if form.quantity.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.quantity.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <span id="patient-quota" class="text-muted small"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.unit_price.id_for_label }}" class="form-label">
                                    {{ form.unit_price.label }}
                                    {% if form.unit_price.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                <div class="input-group">
                                    {{ form.unit_price }}
                                    <span class="input-group-text">{% trans 'ریال' %}</span>
                                </div>
                                {% if form.unit_price.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.unit_price.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <span id="total-price" class="fw-bold">{% trans 'جمع کل:' %} 0 {% trans 'ریال' %}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        <div class="col-12">
                            <div class="form-group">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">
                                    {{ form.notes.label }}
                                    {% if form.notes.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {{ form.notes }}
                                {% if form.notes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.notes.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="col-12 mt-4">
                            <div class="d-flex justify-content-end gap-2">
                                <button type="reset" class="btn btn-light">
                                    <i class="fas fa-undo me-1"></i>
                                    {% trans 'بازنشانی فرم' %}
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>
                                    {% if form.instance.pk %}{% trans 'ذخیره تغییرات' %}{% else %}{% trans 'ثبت تحویل' %}{% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
$(document).ready(function() {
    // Initialize Select2
    $('.select2').select2({
        width: '100%',
        placeholder: 'انتخاب کنید',
        allowClear: true,
        language: 'fa',
        theme: 'bootstrap-5'
    });
    
    // Initialize date picker
    $('#{{ form.dispensing_date.id_for_label }}').pDatepicker({
        format: 'YYYY/MM/DD',
        initialValue: false,
        autoClose: true,
        calendarType: 'persian',
        toolbox: {
            calendarSwitch: {
                enabled: true
            }
        },
        timePicker: {
            enabled: false
        }
    });
    
    // Load patient info when patient is selected
    $('#{{ form.patient.id_for_label }}').on('change', function() {
        const patientId = $(this).val();
        const $patientInfoLink = $('#patient-info-link');
        const $patientInfo = $('#patient-info');
        const $medicationType = $('#{{ form.medication_type.id_for_label }}');
        
        if (patientId) {
            // Show loading
            $patientInfoLink.show();
            $patientInfo.html('<i class="fas fa-spinner fa-spin"></i> در حال بارگذاری...');
            
            // Load patient info
            $.get(`/api/patient/${patientId}/medication-info/`, function(data) {
                if (data.success) {
                    $patientInfo.html(`
                        ${data.patient.full_name} - کد ملی: ${data.patient.national_code}
                        <span class="badge bg-info ms-2">${data.medications.length} داروی فعال</span>
                    `);
                    
                    // Update medication type dropdown
                    $medicationType.empty().append('<option value="">انتخاب دارو</option>');
                    
                    data.medications.forEach(function(med) {
                        $medicationType.append(new Option(
                            `${med.name} (سهمیه باقیمانده: ${med.quota} ${med.unit})`, 
                            med.id,
                            false,
                            false
                        ));
                    });
                    
                    // Trigger change to update other fields
                    $medicationType.trigger('change');
                }
            }).fail(function() {
                $patientInfo.html('<span class="text-danger">خطا در دریافت اطلاعات بیمار</span>');
            });
        } else {
            $patientInfoLink.hide();
            $patientInfo.empty();
            $medicationType.empty().append('<option value="">ابتدا بیمار را انتخاب کنید</option>');
        }
    });
    
    // Load medication info when medication is selected
    $('#{{ form.medication_type.id_for_label }}').on('change', function() {
        const medicationId = $(this).val();
        const $unitDisplay = $('#unit-display');
        const $patientQuota = $('#patient-quota');
        
        if (medicationId) {
            // Get selected option text to extract unit
            const selectedText = $(this).find('option:selected').text();
            const unitMatch = selectedText.match(/\(سهمیه باقیمانده: \d+\s*(\S+)\)/);
            const unit = unitMatch ? unitMatch[1] : '';
            
            // Update unit display
            $unitDisplay.text(unit);
            
            // Update patient quota info
            const quotaMatch = selectedText.match(/سهمیه باقیمانده: (\d+\.?\d*)/);
            if (quotaMatch) {
                $patientQuota.text(`سهمیه باقیمانده بیمار: ${quotaMatch[1]} ${unit}`);
            } else {
                $patientQuota.text('');
            }
            
            // Load medication stock
            $.get(`/api/medication/${medicationId}/stock/`, function(data) {
                if (data.success) {
                    $('#medication-stock').text(`موجودی انبار: ${data.stock} ${data.unit}`);
                }
            });
        } else {
            $unitDisplay.text('-');
            $patientQuota.text('');
            $('#medication-stock').text('');
        }
    });
    
    // Calculate total price when quantity or unit price changes
    $('#{{ form.quantity.id_for_label }}, #{{ form.unit_price.id_for_label }}').on('input', function() {
        const quantity = parseFloat($('#{{ form.quantity.id_for_label }}').val()) || 0;
        const unitPrice = parseFloat($('#{{ form.unit_price.id_for_label }}').val()) || 0;
        const totalPrice = quantity * unitPrice;
        
        $('#total-price').text(`جمع کل: ${totalPrice.toLocaleString('fa-IR')} ریال`);
    });
    
    // Initialize form validation
    $('#medication-dispensing-form').validate({
        rules: {
            patient: 'required',
            medication_type: 'required',
            dispensing_date: 'required',
            quantity: {
                required: true,
                min: 0.01
            },
            unit_price: {
                required: true,
                min: 0
            },
            dispensing_type: 'required'
        },
        messages: {
            patient: 'لطفاً بیمار را انتخاب کنید',
            medication_type: 'لطفاً نوع دارو را انتخاب کنید',
            dispensing_date: 'لطفاً تاریخ تحویل را وارد کنید',
            quantity: {
                required: 'لطفاً مقدار را وارد کنید',
                min: 'مقدار باید بزرگتر از صفر باشد'
            },
            unit_price: {
                required: 'لطفاً قیمت واحد را وارد کنید',
                min: 'قیمت واحد نمی‌تواند منفی باشد'
            },
            dispensing_type: 'لطفاً نوع تحویل را انتخاب کنید'
        },
        errorElement: 'div',
        errorPlacement: function(error, element) {
            error.addClass('invalid-feedback');
            element.closest('.form-group').append(error);
        },
        highlight: function(element, errorClass, validClass) {
            $(element).addClass('is-invalid');
        },
        unhighlight: function(element, errorClass, validClass) {
            $(element).removeClass('is-invalid');
        }
    });
    
    // Trigger initial calculations
    if ($('#{{ form.patient.id_for_label }}').val()) {
        $('#{{ form.patient.id_for_label }}').trigger('change');
    }
    
    // If editing, trigger calculation of total price
    if ($('#{{ form.quantity.id_for_label }}').val() && $('#{{ form.unit_price.id_for_label }}').val()) {
        $('#{{ form.quantity.id_for_label }}').trigger('input');
    }
});
</script>
{% endblock %}
