{% extends 'base.html' %}
{% load static %}

{% block title %}تقویم نوبت دارویی{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
<style>
    #calendar {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 0 24px rgba(0,0,0,0.08);
        padding: 1rem;
        margin-bottom: 2rem;
    }
    .fc-toolbar-title {
        font-size: 1.5rem;
        font-weight: 700;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">تقویم نوبت دارویی</h2>
    <div id="calendar"></div>

    <!-- Modal for adding appointment -->
    <div class="modal fade" id="addAppointmentModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ثبت نوبت جدید</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="addAppointmentForm">
              <div class="mb-3">
                <label for="patientSelect" class="form-label">بیمار</label>
                <select class="form-select" id="patientSelect" name="patient_id" required>
                  <option value="">انتخاب کنید...</option>
                  {% for patient in patients %}
                  <option value="{{ patient.id }}">{{ patient.first_name }} {{ patient.last_name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label for="dateInput" class="form-label">تاریخ نوبت</label>
                <input type="date" class="form-control" id="dateInput" name="date" required>
              </div>
              <div class="mb-3">
                <label for="amountInput" class="form-label">مقدار دارو</label>
                <input type="number" class="form-control" id="amountInput" name="amount" min="0" step="0.01" required>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="isPaidInput" name="is_paid">
                <label class="form-check-label" for="isPaidInput">پرداخت شده</label>
              </div>
              <button type="submit" class="btn btn-primary">ثبت نوبت</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4">
        <h3>لیست نوبت‌های دارویی</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>بیمار</th>
                    <th>تاریخ</th>
                    <th>مقدار دارو</th>
                    <th>وضعیت پرداخت</th>
                </tr>
            </thead>
            <tbody id="appointmentsTableBody">
                <!-- Filled by JS -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'fa',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: '/appointments/api/',
        dateClick: function(info) {
            document.getElementById('dateInput').value = info.dateStr;
            var modal = new bootstrap.Modal(document.getElementById('addAppointmentModal'));
            modal.show();
        },
        eventClick: function(info) {
            var event = info.event;
            alert('بیمار: ' + event.title + '\nتاریخ: ' + event.startStr + '\nمقدار دارو: ' + event.extendedProps.amount + '\nپرداخت: ' + (event.extendedProps.is_paid ? 'بله' : 'خیر'));
        }
    });
    calendar.render();

    // Handle add appointment form
    document.getElementById('addAppointmentForm').onsubmit = function(e) {
        e.preventDefault();
        var data = {
            patient_id: document.getElementById('patientSelect').value,
            date: document.getElementById('dateInput').value,
            amount: document.getElementById('amountInput').value,
            is_paid: document.getElementById('isPaidInput').checked
        };
        fetch('/appointments/create/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if(result.status === 'ok') {
                calendar.refetchEvents();
                bootstrap.Modal.getInstance(document.getElementById('addAppointmentModal')).hide();
                loadAppointmentsTable();
            } else {
                alert('خطا در ثبت نوبت!');
            }
        });
    };

    // Load appointments table
    function loadAppointmentsTable() {
        fetch('/appointments/api/')
        .then(response => response.json())
        .then(events => {
            var tbody = document.getElementById('appointmentsTableBody');
            tbody.innerHTML = '';
            events.forEach(event => {
                var tr = document.createElement('tr');
                tr.innerHTML = `<td>${event.title}</td><td>${event.start}</td><td>${event.extendedProps.amount}</td><td>${event.extendedProps.is_paid ? 'پرداخت شده' : 'پرداخت نشده'}</td>`;
                tbody.appendChild(tr);
            });
        });
    }
    loadAppointmentsTable();
});
</script>
{% endblock %} 