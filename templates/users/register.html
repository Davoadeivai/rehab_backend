{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load socialaccount %}

{% block title %}ثبت نام{% endblock %}

{% block content %}
<style>
    body {
        background: linear-gradient(120deg, #e0eafc 0%, #cfdef3 100%);
        min-height: 100vh;
    }
    .register-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 90vh;
    }
    .register-box {
        display: flex;
        background: #e0f7fa; /* رنگ شاد و روشن فیروزه‌ای */
        border-radius: 22px;
        box-shadow: 0 8px 32px rgba(34,74,190,0.13);
        overflow: hidden;
        max-width: 800px;
        width: 100%;
        min-height: 480px;
    }
    .register-sidebar {
        background: linear-gradient(135deg, #ffb347 0%, #ffcc33 100%);
        color: #fff;
        width: 340px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2.5rem 1.5rem;
        text-align: center;
        border-right: 12px solid #ff9800; /* نوار کناری ضخیم و زیبا */
        box-shadow: 4px 0 24px -8px #ff9800a0;
    }
    .register-sidebar .icon {
        font-size: 3.5rem;
        margin-bottom: 1.2rem;
    }
    .register-sidebar h2 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.7rem;
    }
    .register-sidebar p {
        font-size: 1.1rem;
        opacity: 0.95;
    }
    .register-form-area {
        flex: 1;
        padding: 2.5rem 2rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .register-form-area h3 {
        color: #224abe;
        font-weight: 700;
        margin-bottom: 1.5rem;
        text-align: center;
    }
    .register-form-area label {
        color: #224abe;
        font-weight: 500;
    }
    .register-form-area input[type="text"],
    .register-form-area input[type="password"],
    .register-form-area input[type="email"] {
        border-radius: 8px;
        border: 1px solid #bfc9e0;
        padding: 0.7rem 1rem;
        margin-bottom: 1rem;
        width: 100%;
        font-size: 1rem;
        background: #f7f9fc;
        transition: border 0.2s;
    }
    .register-form-area input:focus {
        border: 1.5px solid #224abe;
        outline: none;
    }
    .register-form-area button[type="submit"] {
        background: linear-gradient(90deg, #4e73df 0%, #224abe 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 0.7rem 0;
        width: 100%;
        font-size: 1.1rem;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(34,74,190,0.08);
        transition: background 0.2s;
    }
    .register-form-area button[type="submit"]:hover {
        background: linear-gradient(90deg, #224abe 0%, #4e73df 100%);
    }
    .register-form-area .alert {
        font-size: 0.95rem;
        margin-bottom: 1rem;
    }
    .register-form-area .login-link {
        display: block;
        text-align: center;
        margin-top: 1.2rem;
        color: #224abe;
        font-weight: 500;
        text-decoration: underline;
    }
    @media (max-width: 900px) {
        .register-box {
            flex-direction: column;
            min-width: 320px;
        }
        .register-sidebar {
            width: 100%;
            min-height: 180px;
            border-radius: 22px 22px 0 0;
        }
    }
    @media (max-width: 600px) {
        .register-form-area {
            padding: 1.2rem 0.5rem;
        }
        .register-sidebar {
            padding: 1.2rem 0.5rem;
        }
    }
.btn-eye-toggle {
    background: none;
    border: none;
    outline: none;
    box-shadow: none;
    padding: 0.2rem 0.5rem;
    color: #224abe;
    font-size: 1.2rem;
    cursor: pointer;
    transition: color 0.2s;
}
.btn-eye-toggle:hover {
    color: #ff9800;
}
.password-strength-container {
    width: 100%;
    margin-bottom: 0.2rem;
}
.password-strength-bar {
    width: 100%;
    height: 7px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 2px;
}
.password-strength-bar-inner {
    height: 100%;
    width: 0%;
    background: #dc3545;
    border-radius: 4px;
    transition: width 0.3s, background 0.3s;
}
.password-strength-text {
    font-size: 0.9rem;
    font-weight: 500;
    margin-right: 0.5rem;
}
</style>

<div class="register-container">
    <div class="register-box">
        <div class="register-sidebar">
            <div class="icon">
                <i class="fas fa-user-plus"></i>
            </div>
            <h2>خوش آمدید!</h2>
            <p>برای استفاده از امکانات سامانه، همین حالا ثبت‌نام کنید.</p>
        </div>
        <div class="register-form-area">
            <h3>ایجاد حساب کاربری جدید</h3>
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
            <form method="post">
                {% csrf_token %}
                {{ form.username|as_crispy_field }}
                {{ form.first_name|as_crispy_field }}
                {{ form.last_name|as_crispy_field }}
                {{ form.email|as_crispy_field }}
                <div style="position:relative;">
                    <label for="id_password1">رمز عبور</label>
                    <div class="password-strength-container mb-2">
                        <div class="password-strength-bar">
                            <div id="password-strength-bar-inner" class="password-strength-bar-inner"></div>
                        </div>
                        <span id="password-strength-text" class="password-strength-text"></span>
                    </div>
                    <input type="password" name="password1" id="id_password1" class="form-control" required autocomplete="new-password">
                    <button type="button" class="btn-eye-toggle" style="position:absolute;top:10px;left:10px;" onclick="togglePassword('id_password1', this)">
                        <i class="fa fa-eye" aria-hidden="true"></i>
                    </button>
                </div>
                <div style="position:relative;">
                    <label for="id_password2">تکرار رمز عبور</label>
                    <input type="password" name="password2" id="id_password2" class="form-control" required autocomplete="new-password">
                    <button type="button" class="btn-eye-toggle" style="position:absolute;top:10px;left:10px;" onclick="togglePassword('id_password2', this)">
                        <i class="fa fa-eye" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="mb-3" id="captcha-box">
                    <label for="id_captcha_1">کد امنیتی</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        {{ form.captcha }}
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-captcha" title="کپچا جدید" tabindex="-1">
                            <i class="fa fa-refresh"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">ثبت نام</button>
            </form>
            <a href="{% url 'login' %}" class="login-link">قبلاً حساب ساخته‌اید؟ وارد شوید</a>
            <a href="{% url 'password_reset' %}" class="login-link" style="color:#e67e22;">رمز عبور را فراموش کرده‌اید؟</a>
        </div>
    </div>
</div>
{% endblock %}

<script>
function togglePassword(id, btn) {
    const input = document.getElementById(id);
    const icon = btn.querySelector('i');
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function getPasswordStrength(password) {
    let score = 0;
    if (!password) return 0;
    if (password.length >= 8) score += 1;
    if (password.match(/[A-Z]/)) score += 1;
    if (password.match(/[a-z]/)) score += 1;
    if (password.match(/[0-9]/)) score += 1;
    if (password.match(/[!@#$%^&*()_+=\[\]{}|;:,.<>?~`\-]/)) score += 1;
    return score;
}

function updateStrengthBar(inputId, barId, textId) {
    const input = document.getElementById(inputId);
    const bar = document.getElementById(barId);
    const text = document.getElementById(textId);
    input.addEventListener('input', function() {
        const score = getPasswordStrength(input.value);
        const percent = (score / 5) * 100;
        bar.style.width = percent + '%';
        let color = '#dc3545', label = 'ضعیف';
        if (score === 2) { color = '#ffc107'; label = 'متوسط'; }
        if (score === 3) { color = '#17a2b8'; label = 'خوب'; }
        if (score >= 4) { color = '#28a745'; label = 'قوی'; }
        bar.style.background = color;
        text.textContent = input.value ? `قدرت رمز: ${label}` : '';
        text.style.color = color;
    });
}

document.addEventListener('DOMContentLoaded', function() {
    updateStrengthBar('id_password1', 'password-strength-bar-inner', 'password-strength-text');
    var refreshBtn = document.getElementById('refresh-captcha');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function(e) {
            e.preventDefault();
            // اگر تصویر داخل <a> است، روی <a> کلیک کن
            var captchaLink = document.querySelector('#captcha-box a');
            if (captchaLink) {
                captchaLink.click();
            } else {
                // اگر فقط <img> است، src را تغییر بده
                var img = document.querySelector('#captcha-box img');
                if (img) {
                    var src = img.src.split('?')[0];
                    img.src = src + '?reload=' + new Date().getTime();
                }
            }
            var input = document.getElementById('id_captcha_1');
            if (input) input.value = '';
        });
    }
});
</script>
